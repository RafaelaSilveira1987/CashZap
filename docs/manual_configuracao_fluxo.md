# Manual de Configuração: Fluxo de Controle Financeiro Multiusuário

**Autor:** Manus AI
**Data:** 2026-01-07

## 1. Introdução

Este manual fornece um guia detalhado para configurar e implantar o fluxo de controle financeiro, permitindo que ele atenda a múltiplos usuários de forma simultânea e segura através de um único canal de WhatsApp. A arquitetura se baseia na integração entre um provedor de API do WhatsApp (para a comunicação), a plataforma de automação N8N (para orquestrar o fluxo) e o banco de dados Supabase (para armazenar os dados de forma isolada).

O princípio fundamental do sistema multiusuário é a associação de cada transação, categoria e interação a um `usuario_id` único. Isso garante que os dados de cada usuário sejam privados e acessíveis apenas por ele.

## 2. Pré-requisitos

Antes de iniciar a configuração, certifique-se de que você possui contas e acesso aos seguintes serviços:

- **Conta no Supabase:** Para criar e gerenciar o banco de dados. O Supabase oferece um plano gratuito generoso, ideal para começar. [1]
- **Plataforma de Automação (N8N):** Onde o fluxo será importado e executado. Você pode usar o N8N Cloud ou uma instância auto-hospedada. [2]
- **API de WhatsApp Business:** Para conectar um número de telefone e automatizar as mensagens. O fluxo foi desenhado com base em provedores como a **Evolution API**, que é uma solução popular e de código aberto. [3]

## 3. Configuração do Banco de Dados (Supabase)

O Supabase armazenará todas as informações dos usuários e suas respectivas movimentações financeiras. A estrutura de dados é composta por três tabelas principais.

### 3.1. Estrutura das Tabelas

A tabela a seguir detalha as colunas necessárias para cada tabela no seu projeto Supabase.

| Tabela                | Coluna         | Tipo de Dado      | Descrição                                                                 |
| --------------------- | -------------- | ----------------- | ------------------------------------------------------------------------- |
| `usuarios`            | `id`           | `bigint` (PK)     | Identificador único do usuário (gerado automaticamente).                  |
|                       | `created_at`   | `timestamptz`     | Data e hora de criação do registro.                                       |
|                       | `nome`         | `text`            | Nome do usuário (opcional).                                               |
|                       | `telefone`     | `text` (Unique)   | Número de telefone do usuário, usado como identificador principal.        |
|                       | `status`       | `text`            | Status do usuário (ex: `ativo`, `inativo`). Padrão: `ativo`.               |
| `categoria_trasacoes` | `id`           | `bigint` (PK)     | Identificador único da categoria.                                         |
|                       | `descricao`    | `text`            | Nome da categoria (ex: Alimentação, Transporte).                          |
|                       | `usuario_id`   | `bigint` (FK)     | Chave estrangeira que referencia `usuarios.id`.                           |
| `transacoes`          | `id`           | `bigint` (PK)     | Identificador único da transação.                                         |
|                       | `descricao`    | `text`            | Descrição da transação (ex: Almoço no restaurante).                       |
|                       | `valor`        | `numeric`         | O valor monetário da transação.                                           |
|                       | `data`         | `date`            | Data em que a transação ocorreu.                                          |
|                       | `mes`          | `integer`         | Mês da transação, para facilitar filtros.                                 |
|                       | `tipo`         | `text`            | Tipo de transação (`entrada` ou `saida`).                                 |
|                       | `pagador`      | `text`            | Informação sobre o pagador ou recebedor (opcional).                       |
|                       | `categoria_id` | `bigint` (FK)     | Chave estrangeira que referencia `categoria_trasacoes.id`.                |
|                       | `usuario_id`   | `bigint` (FK)     | Chave estrangeira que referencia `usuarios.id`.                           |

### 3.2. Scripts SQL para Criação

Para facilitar a configuração, você pode executar os seguintes scripts SQL diretamente no **SQL Editor** do seu projeto Supabase.

```sql
-- 1. Tabela de Usuários
CREATE TABLE public.usuarios (
  id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  nome text NULL,
  telefone text NOT NULL,
  status text NOT NULL DEFAULT 'ativo'::text,
  CONSTRAINT usuarios_pkey PRIMARY KEY (id),
  CONSTRAINT usuarios_telefone_key UNIQUE (telefone)
);

-- 2. Tabela de Categorias
CREATE TABLE public.categoria_trasacoes (
  id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  descricao text NOT NULL,
  usuario_id bigint NOT NULL,
  CONSTRAINT categoria_trasacoes_pkey PRIMARY KEY (id),
  CONSTRAINT categoria_trasacoes_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id) ON DELETE CASCADE
);

-- 3. Tabela de Transações
CREATE TABLE public.transacoes (
  id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  descricao text NOT NULL,
  valor numeric NOT NULL,
  data date NOT NULL,
  mes integer NOT NULL,
  tipo text NOT NULL,
  pagador text NULL,
  categoria_id bigint NOT NULL,
  usuario_id bigint NOT NULL,
  CONSTRAINT transacoes_pkey PRIMARY KEY (id),
  CONSTRAINT transacoes_categoria_id_fkey FOREIGN KEY (categoria_id) REFERENCES public.categoria_trasacoes(id) ON DELETE RESTRICT,
  CONSTRAINT transacoes_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id) ON DELETE CASCADE
);

-- Habilitar Row Level Security (RLS) para segurança
ALTER TABLE public.usuarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categoria_trasacoes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.transacoes ENABLE ROW LEVEL SECURITY;

-- Criar políticas de acesso (Exemplo básico)
-- Permite que usuários vejam e gerenciem apenas seus próprios dados.
CREATE POLICY "Enable all for users based on user_id" ON public.transacoes
AS PERMISSIVE FOR ALL
TO authenticated
USING ( (SELECT auth.uid()) = usuario_id );

CREATE POLICY "Enable all for users based on user_id" ON public.categoria_trasacoes
AS PERMISSIVE FOR ALL
TO authenticated
USING ( (SELECT auth.uid()) = usuario_id );
```

> **Nota de Segurança:** As políticas de Row Level Security (RLS) são cruciais para garantir que um usuário não possa acessar os dados de outro. Os exemplos acima são um ponto de partida. Consulte a documentação do Supabase para criar políticas mais robustas, se necessário.

## 4. Configuração do Fluxo N8N

Com o banco de dados pronto, o próximo passo é configurar o fluxo no N8N.

### 4.1. Importação do Fluxo

1.  Faça o download do arquivo `ControleFinanceiro_RG_DNAICLUB.json`.
2.  Na sua interface do N8N, vá em `New` > `Import from File` e selecione o arquivo JSON.
3.  O fluxo será carregado na tela de edição.

### 4.2. Configuração de Credenciais

O fluxo utiliza nós do Supabase que precisam de autenticação. Você precisará criar uma credencial no N8N.

1.  No menu lateral do N8N, vá em `Credentials` > `New`.
2.  Procure por `Supabase` e selecione.
3.  Preencha os campos:
    *   **Project URL:** Encontrado em `Project Settings` > `API` no seu painel do Supabase.
    *   **Public Key (anon key):** Encontrado na mesma página (`Project API keys`).
4.  Salve a credencial.
5.  Volte ao fluxo e, em cada nó do Supabase (ex: `insere_transacoes`), selecione a credencial que você acabou de criar.

### 4.3. Lógica de Identificação do Usuário

O coração do sistema multiusuário está na capacidade do fluxo de identificar quem está enviando a mensagem e, em seguida, criar ou recuperar seu registro no banco de dados.

1.  **Webhook:** O nó `Webhook` é o ponto de entrada. Ele recebe dados da API do WhatsApp. O número de telefone do remetente geralmente vem em um campo como `body.data.key.remoteJid` ou similar. Verifique a estrutura de dados (payload) enviada pelo seu provedor de API.

2.  **Busca ou Criação de Usuário:** O fluxo original parece assumir que o usuário já existe. É altamente recomendável adicionar uma etapa para verificar a existência do usuário e criá-lo caso seja a primeira interação.

    *   Após o webhook, adicione um nó `Supabase` configurado para a operação `getAll` na tabela `usuarios`.
    *   Adicione um filtro para buscar onde o campo `telefone` é igual ao número do remetente extraído do webhook.
    *   Use um nó `IF` para verificar se a busca retornou algum resultado.
        *   **Se sim (usuário existe):** Prossiga com o fluxo normal, usando o `id` do usuário retornado.
        *   **Se não (novo usuário):** Adicione outro nó `Supabase` com a operação `insert` para criar um novo registro na tabela `usuarios`, salvando o número de telefone. Em seguida, use o `id` deste novo usuário para o resto do fluxo.

Este aprimoramento garante que o sistema seja autossuficiente e possa registrar novos usuários automaticamente.

## 5. Referências

[1] Supabase. [https://supabase.com](https://supabase.com)
[2] N8N. [https://n8n.io](https://n8n.io)
[3] Evolution API. [https://evolution-api.com](https://evolution-api.com)
